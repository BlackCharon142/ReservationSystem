{% extends "base.htm" %}
{% load static %}
{% load humanize %}

{% block extra_assets %}
    {{ block.super }}
    <script src="{% static "script/jquery-3.7.0.min.js" %}"></script>
    <script type="text/javascript" src="{% static "plugins/material-persian-datetime-picker/src/jquery.mpdatepicker.js" %}"></script>
    <link type="text/css" rel="stylesheet"
        href="{% static "plugins/material-persian-datetime-picker/src/jquery.mpdatepicker.css" %}" />

    <link rel="stylesheet" href="{% static "style/reserve.css" %}">
{% endblock %}

{% block title %}رزرو غذا{% endblock %}

{% block content %}
    <div class="reserve-form">
        <div class="date-selection">
            <input type="text" id="myDate" placeholder="تاریخ مورد نظر را انتخاب کنید" class="date-picker text" value="" />
        </div>
        <table class="date-meal-menu text">
            <thead class="date-meal-header">
                <tr>
                    <th></th>
                    <th>غذا</th>
                    <th>توضیحات</th>
                    <th>قیمت</th>
                    <th>تعداد</th>
                </tr>
            </thead>
            <tbody>
            {% for item in todayMenu %}
                <tr class="date-meal-row" data-meal-id="{{ item.id }}">
                    <td><img src="{{ item.image.url }}"></td>
                    <td class="date-meal-name">{{ item.food.name }}</td>
                    <td class="date-meal-description">{{ item.side_dishes.all|join:"، " }}</td>
                    <td class="date-meal-price">{{ item.price|intcomma }}<span> تومان</span></td>
                    <td>
                        <div class="counter" data-min="0" data-max="{{ item.max_purchasable_quantity }}">
                            <button class="decrement">-</button>
                            <div class="number">0</div>
                            <button class="increment">+</button>
                        </div>
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
        <button onclick="window.location.assign('{% url 'dashboard' %}');" class="previous-page text">برگشت</button>
    </div>

    <script src="{% static "script/reserve.js" %}"></script>

    <script type="text/javascript">
        $(function () {
            $(".date-picker").mpdatepicker({
                'timePicker': true,
                onOpen: function () {
                    console.log('open');
                },
                onSelect: function (selected) {
                    console.log('select',selected);
                },
                onChange: function (oldVal, newVal) {
                    console.log('change',oldVal,newVal)
                    const timestamp = newVal;
                    if (timestamp && timestamp !== "null") {
                        fetchMealsForDate(timestamp);
                    }
                },
                onClose: function () {
                    console.log('close');
                },
            });
        });

        function fetchMealsForDate(timestamp) {
            fetch(`/ajax/get-meals/?timestamp=${timestamp}`)
                .then(res => res.json())
                .then(data => {
                    if (data.meals) {
                        updateMealTable(data.meals);
                    } else {
                        updateMealTable([]);
                        console.error(data.error || 'No meals found');
                    }
                })
                .catch(err => console.error('AJAX error:', err));
        }

        function updateMealTable(meals) {
            const tbody = document.querySelector('.date-meal-menu tbody');
            tbody.innerHTML = ''; // clear old rows

            meals.forEach(item => {
                const tr = document.createElement('tr');
                tr.className = 'date-meal-row';
                tr.dataset.mealId = item.id;

                tr.innerHTML = `
                    <td><img src="${item.image_url}" /></td>
                    <td class="date-meal-name">${item.name}</td>
                    <td class="date-meal-description">${item.description}</td>
                    <td class="date-meal-price">${item.price} <span>تومان</span></td>
                    <td>
                        <div class="counter" data-min="0" data-max="${item.max_qty}">
                            <button class="decrement">-</button>
                            <div class="number">0</div>
                            <button class="increment">+</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            updateCounters();
        }


        $(function(){
            const ts    = {{ currentDate }};
            const pDate = $.mpdt.pTimestamp2Date(ts);
            $('#myDate')
                .val(pDate)
                .attr('data-timestamp', ts)
                .trigger('change');
        });
    </script>
{% endblock %}